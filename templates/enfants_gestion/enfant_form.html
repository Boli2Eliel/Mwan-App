{% extends 'base.html' %}

{% block page_title %}
  {% if object %}
    Modifier le dossier de {{ object.prenom }}
  {% else %}
    Cr√©er un nouveau dossier
  {% endif %}
{% endblock %}

{% block page_actions %}
    <a href="{{ request.META.HTTP_REFERER|default:'/' }}" class="btn btn-ghost btn-sm">Annuler</a>
    <button type="submit" form="enfant-form" class="btn btn-warning btn-sm text-white">
        <svg xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
        Enregistrer
    </button>
{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data" id="enfant-form" class="bg-white rounded-lg shadow-sm border border-slate-200">
    {% csrf_token %}

    <div x-data="{ activeTab: 'infos', statutsDeDepart: ['adopte', 'reunifie', 'majeur'], selectedStatut: '{{ form.statut.value|default:'' }}' }">
      <div role="tablist" class="tabs tabs-bordered">
        <a role="tab" class="tab gap-2" @click.prevent="activeTab = 'infos'" :class="{ 'tab-active [--tab-bg:theme(colors.amber.50)] [--tab-border-color:theme(colors.amber.400)]': activeTab === 'infos' }">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
          Infos Personnelles
        </a>
        <a role="tab" class="tab gap-2" @click.prevent="activeTab = 'admission'" :class="{ 'tab-active [--tab-bg:theme(colors.sky.50)] [--tab-border-color:theme(colors.sky.400)]': activeTab === 'admission' }">
          <svg class="w-5 h-5" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.057 1.123-.08M15.75 18H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08M15.75 18.75v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5A3.375 3.375 0 006.375 7.5H5.25m11.9-3.664A2.251 2.251 0 0015 2.25h-1.5a2.251 2.251 0 00-2.15 1.586m5.8 0c.065.21.1.433.1.664v.75h-6v-.75c0-.231.035-.454.1-.664M6.75 7.5H4.875c-.621 0-1.125.504-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-12c0-.621-.504-1.125-1.125-1.125H16.5" /></svg>
          Admission
        </a>
        <a role="tab" class="tab gap-2" @click.prevent="activeTab = 'docs'" :class="{ 'tab-active': activeTab === 'docs' }">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.41l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81" /></svg>
          Documents
        </a>
      </div>

      <div x-show="activeTab === 'infos'" class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
            <div class="form-control w-full">
                <label for="{{ form.prenom.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.prenom.label }}</span></label>
                {{ form.prenom }}
                {% for error in form.prenom.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
            <div class="form-control w-full">
                <label for="{{ form.nom.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.nom.label }}</span></label>
                {{ form.nom }}
                {% for error in form.nom.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
            <div class="form-control w-full">
                <label for="{{ form.date_naissance.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.date_naissance.label }}</span></label>
                {{ form.date_naissance }}
                {% for error in form.date_naissance.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
            <div class="form-control w-full">
                <label for="{{ form.sexe.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.sexe.label }}</span></label>
                {{ form.sexe }}
                {% for error in form.sexe.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
            <div class="form-control w-full md:col-span-2 text-sm">
                <label for="{{ form.lieu_naissance.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.lieu_naissance.label }}</span></label>
                {{ form.lieu_naissance }}
                {% for error in form.lieu_naissance.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
            <div class="form-control w-full md:col-span-2 text-sm">
                <label for="{{ form.photo.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.photo.label }}</span></label>
                {{ form.photo }}
                {% for error in form.photo.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
        </div>
      </div>

      <div x-show="activeTab === 'admission'" class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">

            {% if form.site %}
            <div class="form-control w-full md:col-span-2">
                <label for="{{ form.site.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.site.label }}</span></label>
                {{ form.site }}
                {% for error in form.site.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
            {% endif %}
            
            <div class="form-control w-full">
                <label for="{{ form.date_arrivee.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.date_arrivee.label }}</span></label>
                {{ form.date_arrivee }}
                {% for error in form.date_arrivee.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
            <div class="form-control w-full">
                <label for="{{ form.statut.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.statut.label }}</span></label>
                <select @change="selectedStatut = $event.target.value" name="{{ form.statut.name }}" id="{{ form.statut.id_for_label }}" class="select select-bordered w-full">
                    {% for value, text in form.statut.field.choices %}
                        <option value="{{ value }}" {% if form.statut.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                </select>
                {% for error in form.statut.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
            <div x-show="statutsDeDepart.includes(selectedStatut)" x-transition class="form-control w-full">
                <label for="{{ form.date_depart.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.date_depart.label }}</span></label>
                {{ form.date_depart }}
                {% for error in form.date_depart.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
            <div class="form-control w-full md:col-span-2 text-sm">
                <label for="{{ form.motif_admission.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.motif_admission.label }}</span></label>
                {{ form.motif_admission }}
                {% for error in form.motif_admission.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
            <div class="form-control w-full md:col-span-2 text-sm">
                <label for="{{ form.histoire.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.histoire.label }}</span></label>
                {{ form.histoire }}
                {% for error in form.histoire.errors %}<div class="label"><span class="label-text-alt text-error">{{ error }}</span></div>{% endfor %}
            </div>
        </div>
      </div>

      <div x-show="activeTab === 'docs'" class="p-6">
        {{ document_formset.management_form }}
        {% if document_formset.non_form_errors %}<div class="alert alert-error text-sm p-2 my-2">{{ document_formset.non_form_errors }}</div>{% endif %}
        <div id="document-forms-container" class="space-y-4">
            {% for form in document_formset %}
                <div x-data="{ isMarkedForDeletion: document.querySelector('#{{ form.DELETE.id_for_label }}')?.checked || false }" class="document-form-row relative p-4 border rounded-lg bg-slate-50 transition-opacity" :class="{ 'opacity-40': isMarkedForDeletion }">
                    {{ form.id }}
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-control w-full transition" :class="{ 'line-through': isMarkedForDeletion }">{{ form.type_document }}</div>
                        <div class="form-control w-full transition" :class="{ 'line-through': isMarkedForDeletion }">{{ form.description }}</div>
                        <div class="form-control w-full transition" :class="{ 'line-through': isMarkedForDeletion }">{{ form.fichier }}</div>
                    </div>
                    {% if form.errors %}<div class="md:col-span-3 text-sm text-error mt-2">{{ form.errors }}</div>{% endif %}
                    {% if form.instance.pk %}
                        <div x-init="$el.querySelector('input[type=checkbox]').setAttribute('x-model', 'isMarkedForDeletion')" class="absolute top-2 right-2 flex items-center space-x-2">
                            <label for="{{ form.DELETE.id_for_label }}" class="flex items-center space-x-1 cursor-pointer text-xs text-error font-semibold">{{ form.DELETE }}<span>Supprimer</span></label>
                        </div>
                    {% else %}
                        <button type="button" onclick="removeForm(this)" class="btn btn-xs btn-circle btn-ghost absolute top-2 right-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addForm()" class="btn btn-sm btn-ghost mt-4"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>Ajouter une autre ligne</button>
        <template id="empty-form-template">
             <div class="document-form-row relative p-4 border rounded-lg bg-slate-50">
                {{ document_formset.empty_form.id }}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-control w-full">{{ document_formset.empty_form.type_document }}</div>
                    <div class="form-control w-full">{{ document_formset.empty_form.description }}</div>
                    <div class="form-control w-full">{{ document_formset.empty_form.fichier }}</div>
                </div>
                <button type="button" onclick="removeForm(this)" class="btn btn-xs btn-circle btn-ghost absolute top-2 right-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
        </template>
      </div>

    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    const emptyFormTemplate = document.querySelector('#empty-form-template');
    const formsContainer = document.querySelector('#document-forms-container');
    const totalFormsInput = document.querySelector('#id_document_set-TOTAL_FORMS');
    function addForm() {
        if (!emptyFormTemplate || !formsContainer || !totalFormsInput) { return; }
        const totalForms = parseInt(totalFormsInput.value);
        let newFormHtml = emptyFormTemplate.innerHTML;
        newFormHtml = newFormHtml.replace(/__prefix__/g, totalForms);
        const newFormDiv = document.createElement('div');
        newFormDiv.innerHTML = newFormHtml;
        formsContainer.append(newFormDiv.firstElementChild);
        totalFormsInput.value = totalForms + 1;
    }
    function removeForm(button) {
        const formRow = button.closest('.document-form-row');
        formRow.remove();
    }
</script>
{% endblock %}