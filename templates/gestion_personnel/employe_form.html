{% extends 'base.html' %}

{% block page_title %}
    {% if object.pk %}Modifier la Fiche de {{ object }}{% else %}Ajouter un Employé{% endif %}
{% endblock %}

{% block page_actions %}
    <a href="{% url 'gestion_personnel:employe_list' %}" class="btn btn-ghost btn-sm">Annuler</a>
    <button type="submit" form="employe-form" class="btn btn-warning btn-sm text-white">Enregistrer</button>
{% endblock %}

{% block content %}
<form method="post" id="employe-form" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200" 
      x-data="{ userAction: 'none' }">
    {% csrf_token %}
    
    <input type="hidden" name="user_action" :value="userAction">

    <div class="space-y-8">
        <div>
            <h2 class="text-lg font-semibold text-slate-800 border-b pb-2 mb-6">Informations sur l'Employé</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                <div class="form-control w-full"><label for="{{ form.nom.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.nom.label }}</span></label>{{ form.nom }}</div>
                <div class="form-control w-full"><label for="{{ form.prenom.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.prenom.label }}</span></label>{{ form.prenom }}</div>
                <div class="form-control w-full"><label for="{{ form.poste.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.poste.label }}</span></label>{{ form.poste }}</div>
                <div class="form-control w-full"><label for="{{ form.type_contrat.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.type_contrat.label }}</span></label>{{ form.type_contrat }}</div>
                <div class="form-control w-full"><label for="{{ form.date_embauche.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.date_embauche.label }}</span></label>{{ form.date_embauche }}</div>
                <div class="form-control w-full"><label for="{{ form.telephone.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.telephone.label }}</span></label>{{ form.telephone }}</div>
                <div class="form-control w-full md:col-span-2"><label for="{{ form.adresse.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.adresse.label }}</span></label>{{ form.adresse }}</div>
                <div class="form-control w-full md:col-span-2">
                    <label class="label"><span class="label-text text-slate-600 text-xs">{{ form.sites.label }}</span></label>
                    <div class="p-4 border bg-slate-50 rounded-md max-h-40 overflow-y-auto">
                        {{ form.sites }}
                    </div>
                </div>
            </div>
        </div>

        <div>
            <h2 class="text-lg font-semibold text-slate-800 border-b pb-2 mb-6">Compte Utilisateur</h2>
            {% if object.utilisateur %}
                <p class="text-sm p-4 bg-slate-100 rounded-md">Cet employé est déjà lié au compte : <strong>{{ object.utilisateur.username }}</strong>.</p>
            {% else %}
            <div class="space-y-4">
                <span class="label-text text-slate-600 text-xs font-semibold">Gestion du compte d'accès</span>
                <div class="join">
                    <button type="button" @click="userAction = 'none'" class="join-item btn btn-sm" :class="{ 'btn-active btn-neutral': userAction === 'none' }">Ne rien faire</button>
                    <button type="button" @click="userAction = 'create'" class="join-item btn btn-sm" :class="{ 'btn-active btn-neutral': userAction === 'create' }">Créer un compte</button>
                    <button type="button" @click="userAction = 'link'" class="join-item btn btn-sm" :class="{ 'btn-active btn-neutral': userAction === 'link' }">Lier un compte</button>
                </div>

                <div x-show="userAction === 'create'" x-transition class="mt-4 pl-6 border-l-2 border-amber-200 space-y-2">
                    <h3 class="text-md font-semibold text-slate-700 mb-4">Détails du nouveau compte</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                        <div class="form-control w-full">{{ form.username.label_tag }}{{ form.username }}</div>
                        <div class="form-control w-full">{{ form.email.label_tag }}{{ form.email }}</div>
                        <div class="form-control w-full">{{ form.role.label_tag }}{{ form.role }}</div>
                        <div class="form-control w-full">{{ form.password.label_tag }}{{ form.password }}</div>
                    </div>
                </div>

                <div x-show="userAction === 'link'" x-transition class="mt-4 pl-6 border-l-2 border-sky-200">
                    <div class="form-control w-full">{{ form.lier_utilisateur.label_tag }}{{ form.lier_utilisateur }}</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</form>
{% endblock %}