{% extends 'base.html' %}
{% load static %}

{% block page_title %}
    {% if object.pk %}Modifier la Fiche de {{ object }}{% else %}Ajouter un Employé{% endif %}
{% endblock %}

{% block page_actions %}
    <a href="{% url 'gestion_personnel:employe_list' %}" class="btn btn-ghost btn-sm">Annuler</a>
    <button type="submit" form="employe-form" class="btn btn-warning btn-sm text-white">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
        Enregistrer
    </button>
{% endblock %}

{% block content %}
<form method="post" id="employe-form" class="bg-white rounded-lg shadow-sm border border-slate-200">
    {% csrf_token %}
    
    <div x-data="{ 
            activeTab: 'general', 
            userAction: '{{ form.user_action.value|default:'none' }}' 
         }">
      
      <div role="tablist" class="tabs tabs-bordered">
        <a role="tab" @click.prevent="activeTab = 'general'" :class="{ 'tab-active [--tab-bg:theme(colors.amber.50)] [--tab-border-color:theme(colors.amber.400)]': activeTab === 'general' }" class="tab gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0H9m7 0h-4"/></svg>
          Informations
        </a>
        <a role="tab" @click.prevent="activeTab = 'compte'" :class="{ 'tab-active [--tab-bg:theme(colors.sky.50)] [--tab-border-color:theme(colors.sky.400)]': activeTab === 'compte' }" class="tab gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          Compte d'Accès
        </a>
      </div>

      <input type="hidden" name="user_action" :value="userAction">

      <div x-show="activeTab === 'general'" class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
            <div class="form-control w-full"><label for="{{ form.nom.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.nom.label }}</span></label>{{ form.nom }}</div>
            <div class="form-control w-full"><label for="{{ form.prenom.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.prenom.label }}</span></label>{{ form.prenom }}</div>
            <div class="form-control w-full"><label for="{{ form.poste.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.poste.label }}</span></label>{{ form.poste }}</div>
            <div class="form-control w-full"><label for="{{ form.type_contrat.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.type_contrat.label }}</span></label>{{ form.type_contrat }}</div>
            <div class="form-control w-full"><label for="{{ form.date_embauche.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.date_embauche.label }}</span></label>{{ form.date_embauche }}</div>
            <div class="form-control w-full"><label for="{{ form.telephone.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.telephone.label }}</span></label>{{ form.telephone }}</div>
            <div class="form-control w-full md:col-span-2"><label for="{{ form.adresse.id_for_label }}" class="label"><span class="label-text text-slate-600 text-xs">{{ form.adresse.label }}</span></label>{{ form.adresse }}</div>
            <div class="form-control w-full md:col-span-2">
                <label class="label"><span class="label-text text-slate-600 text-xs">{{ form.sites.label }}</span></label>
                <div class="p-4 border bg-slate-50 rounded-md max-h-40 overflow-y-auto">
                    {{ form.sites }}
                </div>
            </div>
        </div>
      </div>
      
      <div x-show="activeTab === 'compte'" class="p-6">
        {% if object.utilisateur %}
            <p class="text-sm p-4 bg-slate-100 rounded-md">Cet employé est déjà lié au compte : <strong>{{ object.utilisateur.username }}</strong>.</p>
        {% else %}
        <div class="space-y-4">
            <span class="label-text text-slate-600 text-xs font-semibold">Gestion du compte d'accès</span>
            <div class="join">
                <button type="button" @click="userAction = 'none'" class="join-item btn btn-sm" :class="{ 'btn-active btn-neutral': userAction === 'none' }">Ne rien faire</button>
                <button type="button" @click="userAction = 'create'" class="join-item btn btn-sm" :class="{ 'btn-active btn-neutral': userAction === 'create' }">Créer un compte</button>
                <button type="button" @click="userAction = 'link'" class="join-item btn btn-sm" :class="{ 'btn-active btn-neutral': userAction === 'link' }">Lier un compte</button>
            </div>

            <div x-show="userAction === 'create'" x-transition class="mt-4 pl-6 border-l-2 border-amber-200 space-y-2">
                <h3 class="text-md font-semibold text-slate-700 mb-4">Détails du nouveau compte</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                    <div class="form-control w-full">{{ form.username.label_tag }}{{ form.username }}</div>
                    <div class="form-control w-full">{{ form.email.label_tag }}{{ form.email }}</div>
                    <div class="form-control w-full">{{ form.role.label_tag }}{{ form.role }}</div>
                    <div class="form-control w-full">{{ form.password.label_tag }}{{ form.password }}</div>
                </div>
            </div>

            <div x-show="userAction === 'link'" x-transition class="mt-4 pl-6 border-l-2 border-sky-200">
                <h3 class="text-md font-semibold text-slate-700 mb-4">Lier un compte existant</h3>
                <div class="form-control w-full">{{ form.lier_utilisateur.label_tag }}{{ form.lier_utilisateur }}</div>
            </div>
        </div>
        {% endif %}
      </div>
    </div>
</form>
{% endblock %}