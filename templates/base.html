{% load static %}
{% load auth_extras %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Mwan'App{% endblock %}</title>
    
    <script src="//unpkg.com/alpinejs" defer></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="{% static 'css/output.css' %}" rel="stylesheet">
    
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-slate-100 font-sans antialiased" x-data="{ sidebarOpen: false }" @keydown.escape.window="sidebarOpen = false">

    <div class="flex h-screen bg-slate-100">
        
        <aside class="w-60 flex-shrink-0 bg-slate-800 text-white flex flex-col fixed inset-y-0 left-0 z-30 transition-transform duration-300 ease-in-out md:relative md:translate-x-0"
               :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'">
            
            <div class="h-16 flex items-center justify-center px-4 border-b border-slate-700">
                <h1 class="text-xl font-bold text-white tracking-wider">Mwan'App ✨</h1>
            </div>
            
            <nav class="flex-1 px-2 py-4 space-y-1">
                <a href="{% url 'dashboard:home' %}" class="group flex items-center px-3 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg">
                    <svg class="h-5 w-5 mr-3 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    Tableau de Bord
                </a>
                
                {% if perms.enfants_gestion.view_enfant or perms.gestion_personnel.view_employe %}
                <div x-data="{ open: true }">
                    <button @click="open = !open" class="w-full flex justify-between items-center px-3 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg group">
                        <span class="flex items-center">
                            <svg class="h-5 w-5 mr-3 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg>
                            Gestion
                        </span>
                        <svg class="h-4 w-4 transform transition-transform" :class="{'rotate-180': open}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div x-show="open" x-transition class="mt-1 ml-4 pl-3 border-l border-slate-700 space-y-1">
                        {% if perms.enfants_gestion.view_enfant %}
                        <a href="{% url 'enfants_gestion:enfant_list' %}" class="group flex items-center px-3 py-2 text-xs font-medium text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg">
                           <svg class="h-4 w-4 mr-3 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            Enfants
                        </a>
                        {% endif %}
                        {% if perms.gestion_personnel.view_employe %}
                        <a href="{% url 'gestion_personnel:employe_list' %}" class="group flex items-center px-3 py-2 text-xs font-medium text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg">
                           <svg class="h-4 w-4 mr-3 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.964A3 3 0 013 16.5v-1.5a3 3 0 013-3h12a3 3 0 013 3v1.5a3 3 0 01-3 3m-12.75-9.401A4.5 4.5 0 009 6.345a4.5 4.5 0 00-9 0m12.75 0a4.5 4.5 0 00-9 0" /></svg>
                            Personnel
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if perms.gestion_financiere.view_transaction or perms.gestion_financiere.view_parrainage %}
                <div x-data="{ open: true }">
                    <button @click="open = !open" class="w-full flex justify-between items-center px-3 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg group">
                        <span class="flex items-center">
                            <svg class="h-5 w-5 mr-3 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75" /></svg>
                            Opérations
                        </span>
                        <svg class="h-4 w-4 transform transition-transform" :class="{'rotate-180': open}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div x-show="open" x-transition class="mt-1 ml-4 pl-3 border-l border-slate-700 space-y-1">
                        {% if perms.gestion_financiere.view_transaction %}
                        <a href="{% url 'gestion_financiere:transaction_list' %}" class="group flex items-center px-3 py-2 text-xs font-medium text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg">
                           <svg class="h-4 w-4 mr-3 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 11.25v8.25a2.25 2.25 0 01-2.25 2.25H5.25a2.25 2.25 0 01-2.25-2.25v-8.25a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 11.25z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v12.75m0 0l-3-3m3 3l3-3" /></svg>
                           Transactions
                        </a>
                        {% endif %}
                        {% if perms.gestion_financiere.view_parrainage %}
                        <a href="{% url 'gestion_financiere:parrainage_list' %}" class="group flex items-center px-3 py-2 text-xs font-medium text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg">
                           <svg class="h-4 w-4 mr-3 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>
                            Parrainages
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <div class="pt-2"><div class="border-t border-slate-700"></div></div>
                
                {% if perms.gestion_financiere.view_transaction %}
                <a href="{% url 'gestion_financiere:rapport_financier' %}" class="group flex items-center px-4 py-2 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg">
                    <svg class="h-5 w-5 mr-3 text-slate-400 group-hover:text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
                    Rapports Financiers
                </a>
                {% endif %}

                {% if perms.enfants_gestion.view_enfant %}
                <a href="{% url 'enfants_gestion:enfant_export' %}" class="group flex items-center px-4 py-2 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg">
                    <svg class="h-5 w-5 mr-3 text-slate-400 group-hover:text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    Extractions de Données
                </a>
                {% endif %}
            </nav>
            
            <div class="relative border-t border-slate-700 p-4" x-data="{ open: false }" x-cloak>
                <div x-show="open" @click.outside="open = false" x-transition class="absolute bottom-full mb-2 w-[calc(100%-2rem)] bg-slate-700 rounded-lg shadow-lg overflow-hidden">
                    <a href="#" class="group flex items-center px-3 py-3 text-sm font-medium text-slate-300 hover:bg-slate-600 hover:text-white"><svg class="h-5 w-5 mr-3 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.793 2.39A6.483 6.483 0 0010 16.5a6.483 6.483 0 004.793-2.11A5.99 5.99 0 0010 12z" clip-rule="evenodd" /></svg>Gérer mon profil</a>
                    {% if user.is_superuser %}<a href="/admin/" class="group flex items-center px-3 py-3 text-sm font-medium text-slate-300 hover:bg-slate-600 hover:text-white"><svg class="h-5 w-5 mr-3 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>Administration</a>{% endif %}
                    <form action="{% url 'logout' %}" method="post" class="w-full">
                        {% csrf_token %}
                        <button type="submit" class="w-full text-left group flex items-center px-3 py-3 text-sm font-medium text-slate-300 hover:bg-slate-600 hover:text-white">
                            <svg class="h-5 w-5 mr-3 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
                            Déconnexion
                        </button>
                    </form>
                </div>
                <button @click="open = !open" class="w-full flex items-center p-2 text-sm text-slate-300 hover:bg-slate-700 rounded-lg text-left group">
                    <span class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><span class="font-bold text-xs">{{ user.username|first|upper }}</span></span>
                    <span class="ml-3 truncate"><span class="block font-semibold">{{ user.username }}</span><span class="block text-xs text-slate-400">{{ user.get_role_display }}</span></span>
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center h-16">
                <div class="md:hidden">
                    <button @click.prevent="sidebarOpen = !sidebarOpen" class="p-2 rounded-md text-slate-500 hover:bg-slate-100">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-slate-800">{% block page_title %}Tableau de bord{% endblock %}</h2>
                </div>
                <div class="ml-auto flex items-center space-x-4">
                    <div class="hidden sm:block">{% block page_actions %}{% endblock %}</div>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto p-6">
                {% block content %}{% endblock %}
            </main>
        </div>

        <div x-show="sidebarOpen" @click="sidebarOpen = false" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden" x-transition.opacity></div>
    </div>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% if messages %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const Toast = Swal.mixin({
              toast: true,
              position: 'top-end',
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true,
              didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
              }
            });
            {% for message in messages %}
                Toast.fire({
                  icon: '{{ message.tags }}',
                  title: '{{ message }}'
                });
            {% endfor %}
        });
    </script>
    {% endif %}
    {% block extra_js %}{% endblock %}
</body>
</html>